<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../../../img/favicon.ico" />
    <title>How To Manually Test Mde’S Ecs Networking - The Escalation Protocol</title>
    <link rel="stylesheet" href="../../../../css/theme.css" />
    <link rel="stylesheet" href="../../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../../../stylesheets/nav.css" rel="stylesheet" />
        <link href="../../../../stylesheets/layout.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "How To Manually Test Mde\u2019S Ecs Networking";
        var mkdocs_page_input_path = "Defender for Endpoint/Endpoint Detection and Response/ECS/How to Manually Test MDE\u2019s ECS Networking.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../../.." class="icon icon-home"> The Escalation Protocol
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Defender for Endpoint</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" >Endpoint Detection and Response</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" >Alert Tunning</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../Alert%20Tunning/Alert-Tuning-Quick%E2%80%90Start-Guide-%28Beginner-Edition%29/">Alert Tuning Quick‐Start Guide (Beginner Edition)</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Alert%20Tunning/Alert-Tuning-%E2%80%93-Comprehensive-Guide-%28Advanced-Edition%29/">Alert Tuning – Comprehensive Guide (Advanced Edition)</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Device Control</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../Device%20Control/How-to-Configure-Device-Control-on-macOS%2C-Use-case-1.-Deny-write-access-to-all-USB-storage-except-for-specific-VendorID-and-ProductID-combinations-%28Jamf%29/">How To Configure Device Control On Macos, Use Case 1. Deny Write Access To All Usb Storage Except For Specific Vendorid And Productid Combinations (Jamf)</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Device%20Control/Using-the-device-control-policy-sample-builder/">Using The Device Control Policy Sample Builder</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" >ECS</a>
    <ul class="current">
                <li class="toctree-l3 current"><a class="reference internal current" href="#">How To Manually Test Mde’S Ecs Networking</a>
    <ul class="current">
    <li class="toctree-l4"><a class="reference internal" href="#summary">Summary</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#details">Details</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#solution-manual-ecs-network-test-script">Solution: Manual ECS Network Test Script</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#output">Output</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#additional-notes">Additional Notes</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#applies-to">Applies To</a>
    </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../mde_connectivity_channels/">Mde Connectivity Channels</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Microsoft Defender Core Service</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../Microsoft%20Defender%20Core%20Service/ecs_connectivity_diagnostic/">Ecs Connectivity Diagnostic</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Tags</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../Tags/Data-Driven%20Tags%20%E2%80%93%20Disabled%20and%20Isolated%20in%20Microsoft%20Defender%20for%20Endpoint/">Data Driven Tags – Disabled And Isolated In Microsoft Defender For Endpoint</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Threat Vulnerability Management</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../Threat%20Vulnerability%20Management/Troubleshooting-Guide-%28TSG%29-CVE%E2%80%902023%E2%80%9049210-%E2%80%93-OpenSSL-Vulnerability-in-node%E2%80%90openssl-NPM-Package/">Troubleshooting Guide (Tsg) Cve‐2023‐49210 – Openssl Vulnerability In Node‐Openssl Npm Package</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Support Tips and Tools</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../Support%20Tips%20and%20Tools/Effective-Case-Notation-Good-practices-and-template/">Effective Case Notation Good Practices And Template</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../Support%20Tips%20and%20Tools/How-to-Craft-an-Effective-Root-Cause-Analysis-%28RCA%29/">How To Craft An Effective Root Cause Analysis (Rca)</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Derecho informático</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../Derecho%20inform%C3%A1tico/Delitos-Inform%C3%A1ticos-en-Costa-Rica-Mapeo-Jur%C3%ADdico%E2%80%90T%C3%A9cnico-y-Controles-ATT%26CK/">Delitos Informáticos En Costa Rica Mapeo Jurídico‐Técnico Y Controles Att&Ck</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../Derecho%20inform%C3%A1tico/Reflexi%C3%B3n%2C-Bienes-jur%C3%ADdicos-tutelados-en-una-eventual-legislaci%C3%B3n-de-IA-en-Costa-Rica/">Reflexión, Bienes Jurídicos Tutelados En Una Eventual Legislación De Ia En Costa Rica</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Day-to-Day Stuff</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../Day-to-Day%20Stuff/birthday-reminders/">Birthday Reminders</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../..">The Escalation Protocol</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Defender for Endpoint</li>
          <li class="breadcrumb-item">Endpoint Detection and Response</li>
          <li class="breadcrumb-item">ECS</li>
      <li class="breadcrumb-item active">How To Manually Test Mde’S Ecs Networking</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="how-to-manually-test-microsoft-defenders-ecs-networking-component">How to Manually Test Microsoft Defender’s ECS Networking Component</h1>
<h2 id="summary">Summary</h2>
<p>Microsoft Defender for Endpoint (MDE) includes an ECS (Endpoint Cloud Service) component responsible for coordinating cloud-based threat intelligence and updates. While most ECS functionality is validated by the Client Analyzer tool, the <strong>networking portion is not tested</strong> by it. This article explains the behavior and provides a script to manually verify ECS connectivity and DNS resolution.</p>
<hr />
<h2 id="details">Details</h2>
<p><strong>Environment:</strong>
- Microsoft Defender for Endpoint<br />
- Windows 10/11, Server 2016-2022<br />
- ECS functionality enabled  </p>
<p><strong>Issue:</strong>
ECS connectivity issues may arise, but the <strong>Client Analyzer</strong> tool does <strong>not</strong> currently test the <strong>network layer</strong> or the ability to reach ECS endpoints over HTTPS.</p>
<p><strong>Clarification:</strong>
The ECS module uses specific telemetry URLs and network routes that may not follow the standard update or telemetry paths. Manual validation is often required, especially in environments with custom proxies, DPI/SSL inspection, or strict outbound firewall rules.</p>
<hr />
<h2 id="solution-manual-ecs-network-test-script">Solution: Manual ECS Network Test Script</h2>
<p>The following PowerShell script performs:</p>
<ul>
<li>Network trace capture  </li>
<li>ECS URL detection  </li>
<li>DNS resolution  </li>
<li>Port 443 connectivity test  </li>
<li>Proxy configuration readout  </li>
<li>ECS endpoint web request</li>
</ul>
<blockquote>
<p><strong>Note:</strong> Run this in an <strong>elevated PowerShell session</strong>. The script will create a <code>.txt</code> report and <code>.etl</code> network trace file on the user's Desktop.</p>
</blockquote>
<details>
<summary><strong>Click to expand the full PowerShell script</strong></summary>


<pre><code class="language-powershell"># --- Setup Paths and Timestamps ---
$desktopPath = [Environment]::GetFolderPath(&quot;Desktop&quot;)
$timestamp = Get-Date -Format &quot;yyyyMMdd_HHmmss&quot;
$reportName = &quot;Defender_ECS_Report_$timestamp.txt&quot;
$reportPath = Join-Path $desktopPath $reportName
$traceName = &quot;Defender_ECS_Capture_$timestamp.etl&quot;
$traceTempPath = Join-Path $env:TEMP $traceName
$traceFinalPath = Join-Path $desktopPath $traceName

# Clear/Create report file
&quot;&quot; | Out-File -FilePath $reportPath -Encoding UTF8

# --- Start Network Capture ---
&quot;Starting network capture...&quot; | Tee-Object -FilePath $reportPath -Append
netsh trace start capture=yes tracefile=&quot;$traceTempPath&quot; persistent=no maxsize=100 overwrite=yes | Out-String | Tee-Object -FilePath $reportPath -Append

# --- Locate MpCmdRun.exe in Latest Defender Platform ---
$basePath = &quot;C:\ProgramData\Microsoft\Windows Defender\Platform&quot;
$latestDir = Get-ChildItem -Path $basePath -Directory |
    Where-Object { $_.Name -match '^\d+\.\d+\.\d+\.\d+-\d+$' } |
    Sort-Object Name -Descending |
    Select-Object -First 1

$mpCmdRunPath = Join-Path -Path $latestDir.FullName -ChildPath &quot;MpCmdRun.exe&quot;
&quot;Latest Defender Platform: $($latestDir.Name)&quot; | Tee-Object -FilePath $reportPath -Append

# --- Get ECS Base URL ---
$ecsOutput = &amp; $mpCmdRunPath -DisplayECSConnection
$ecsBaseUrl = ($ecsOutput | Where-Object { $_ -match '^ECS Url:' }) -replace '^ECS Url:\s*', ''

# --- Build Full URL ---
$queryString = '?CampPlatformVersion=6&amp;EngineMinorVersion=1&amp;EngineRing=2&amp;EngineVersion=25060&amp;IsBeta=0&amp;IsEmbedded=0&amp;IsEnterprise=1&amp;IsMsSense=1&amp;IsMsft=0&amp;IsServer=1&amp;IsSeville=1&amp;MoCampBuildRev=1641676800&amp;MoCampVersion=262162&amp;OsBuildMinNumber=2134&amp;OsBuildNumber=22621&amp;OsMajorMinorVersion=655360&amp;PlatformRing=2&amp;SignatureRing=5&amp;Engine_Ring=2'
$finalUrl = &quot;$ecsBaseUrl&quot; + 'MicrosoftWindowsDefenderClient/1.0.0.0' + $queryString
&quot;Final ECS URL: $finalUrl&quot; | Tee-Object -FilePath $reportPath -Append

# --- DNS and Connectivity Tests ---
try {
    $ecsUri = [System.Uri]$finalUrl
    $hostName = $ecsUri.Host

    &quot;DNS Lookup for ${hostName}:&quot; | Tee-Object -FilePath $reportPath -Append
    Resolve-DnsName $hostName -ErrorAction SilentlyContinue | Out-String | Tee-Object -FilePath $reportPath -Append

    &quot;Port 443 Connectivity Test:&quot; | Tee-Object -FilePath $reportPath -Append
    Test-NetConnection -ComputerName $hostName -Port 443 | Out-String | Tee-Object -FilePath $reportPath -Append
} catch {
    &quot;Could not resolve or test connectivity to $hostName&quot; | Tee-Object -FilePath $reportPath -Append
}

# --- Show System Proxy Settings ---
&quot;System Proxy Configuration:&quot; | Tee-Object -FilePath $reportPath -Append
(netsh winhttp show proxy) | Out-String | Tee-Object -FilePath $reportPath -Append

# --- ECS Web Request ---
try {
    $response = Invoke-WebRequest -Uri $finalUrl -UseBasicParsing -ErrorAction Stop

    &quot;Web Request Successful:&quot; | Tee-Object -FilePath $reportPath -Append
    &quot;Status Code: $($response.StatusCode)&quot; | Tee-Object -FilePath $reportPath -Append
    &quot;Response Headers:&quot; | Tee-Object -FilePath $reportPath -Append
    $response.Headers | Out-String | Tee-Object -FilePath $reportPath -Append
} catch {
    &quot;Web Request Failed:&quot; | Tee-Object -FilePath $reportPath -Append
    &quot;Error Message: $($_.Exception.Message)&quot; | Tee-Object -FilePath $reportPath -Append

    if ($_.Exception.InnerException) {
        &quot;Inner Exception: $($_.Exception.InnerException.Message)&quot; | Tee-Object -FilePath $reportPath -Append
    }

    if ($_.Exception -is [System.Net.WebException]) {
        $webEx = $_.Exception
        if ($webEx.Response) {
            $reader = New-Object System.IO.StreamReader($webEx.Response.GetResponseStream())
            $body = $reader.ReadToEnd()
            &quot;Server Response:&quot; | Tee-Object -FilePath $reportPath -Append
            $body | Tee-Object -FilePath $reportPath -Append
        }
    }
}

# --- Stop Network Capture ---
&quot;Stopping network capture...&quot; | Tee-Object -FilePath $reportPath -Append
netsh trace stop | Out-String | Tee-Object -FilePath $reportPath -Append
Start-Sleep -Seconds 2

# --- Move ETL File to Desktop ---
if (Test-Path $traceTempPath) {
    Move-Item -Path $traceTempPath -Destination $traceFinalPath -Force
    &quot;ETL file saved to: $traceFinalPath&quot; | Tee-Object -FilePath $reportPath -Append
} else {
    &quot;Trace file not found in temp location.&quot; | Tee-Object -FilePath $reportPath -Append
}

# --- Final Report Location ---
&quot;Diagnostic report saved to: $reportPath&quot; | Tee-Object -FilePath $reportPath -Append

# --- Open ECS URL in Default Browser ---
Start-Process $finalUrl
</code></pre>

</details>

<hr />
<h2 id="output">Output</h2>
<ul>
<li><strong>ETL File:</strong> Captures ECS network traffic  </li>
<li><strong>Report File:</strong> Includes:</li>
<li>Platform version used</li>
<li>ECS base and full URLs</li>
<li>DNS resolution results</li>
<li>Port 443 connectivity</li>
<li>Proxy config</li>
<li>ECS web request result</li>
</ul>
<hr />
<h2 id="additional-notes">Additional Notes</h2>
<ul>
<li>If the <code>Invoke-WebRequest</code> fails, investigate proxy settings, DNS filtering, or outbound HTTPS rules.</li>
<li>ECS uses <code>MicrosoftWindowsDefenderClient</code> URLs that are <strong>not used for AV updates</strong>.</li>
</ul>
<hr />
<h2 id="applies-to">Applies To</h2>
<ul>
<li>Microsoft Defender for Endpoint  </li>
<li>Microsoft Defender AV Platform versions 4.18.x and newer</li>
</ul>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../../Device%20Control/Using-the-device-control-policy-sample-builder/" class="btn btn-neutral float-left" title="Using The Device Control Policy Sample Builder"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../../mde_connectivity_channels/" class="btn btn-neutral float-right" title="Mde Connectivity Channels">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../../Device%20Control/Using-the-device-control-policy-sample-builder/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../mde_connectivity_channels/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../../..";</script>
    <script src="../../../../js/theme_extra.js"></script>
    <script src="../../../../js/theme.js"></script>
      <script src="../../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
